{% load staticfiles %}
{% load identity_extras %}
<!DOCTYPE html>
<html>
    <head>
        <title>Doctors</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">
        <style type='text/css'>
            @import url('{% static 'css/daterangepicker.css' %}');
            @import url('{% static 'css/jquery.datetimepicker.css' %}');
            @import url('{% static 'css/jquery-clockpicker.css' %}');
            @import url('{% static 'css/bootstrap-clockpicker.css' %}');
            @import url('{% static 'css/common.css' %}');
            @import url('{% static 'css/heading.css' %}');
            @import url('{% static 'css/doctor.css' %}');

            @import url('{% static 'css/sprite/notice.css' %}');
            @import url('{% static 'css/sprite/doctor.css' %}');
            @import url('{% static 'css/sprite/notice.css' %}');
            @import url('{% static 'css/sprite/appointment.css' %}');
            @import url('{% static 'css/sprite/negotiation.css' %}');
            @import url('{% static 'css/sprite/ministory.css' %}');
            @import url('{% static 'css/sprite/patient.css' %}');
            @import url('{% static 'css/sprite/admission.css' %}');

            @import url('{% static 'css/panel/doctor.css' %}');
            @import url('{% static 'css/panel/admissions.css' %}');
            @import url('{% static 'css/panel/patients.css' %}');
            @import url('{% static 'css/panel/appointments.css' %}');
            @import url('{% static 'css/panel/ministories.css' %}');
            @import url('{% static 'css/panel/story-creation.css' %}');
            @import url('{% static 'css/sprite/story-viewer.css' %}');
            @import url('{% static 'css/sprite/doctor.css' %}');
            @import url('{% static 'css/sprite/patient.css' %}');
            @import url('{% static 'css/sprite/admission.css' %}');
            @import url('{% static 'css/sprite/complaint.css' %}');
            @import url('{% static 'css/sprite/prescription.css' %}');
            @import url('{% static 'css/panel/chat.css' %}');

            .component-sprite{
                margin-right: 3px;
                margin-bottom: 3px;
            }
            .doctor-sprite{
                float: left;
            }
            .patient-sprite{
                float: left;
            }
            .organization-sprite{
                width: 501px;
                float: left;
            }
            .filter{
                margin: 0px;
                padding: 0px;
                color: white;
                float: left;
                position: relative;
            }
            .filter:hover{
                margin: 0px;
                padding: 0px;
            }
            .filter-button{
                list-style-type: none;
                float: left;
                margin-left: 7px;
                padding-top: 8px;
            }
            .filter-button:hover{
                background: #E4E4E6;
                margin: 0px;
                color: #252734;
                height: 100%;
                padding-left: 7px;
                padding-right: 7px;
                padding-bottom: 7px;
                cursor: pointer;
            }
            .patient-item{

            }
        </style>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/1.3.4/jquery.fancybox-1.3.4.css" />
        <script type="text/javascript" src="{% static 'js/jquery.3.2.1.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/arboreal.js' %}"></script>
        <script src="{% static 'js/jquery.fancybox-1.3.4_patch.js' %}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/1.3.4/jquery.easing-1.3.pack.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/1.3.4/jquery.mousewheel-3.0.4.pack.js"></script>
        <script type="text/javascript" src="{% static 'js/jquery.sticky-kit.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/jquery.cookie.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/d3.v3.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/bootstrap-clockpicker.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/moment.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/jquery.datetimepicker.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/jquery.daterangepicker.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/sprite/appointment.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/panel/appointments.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/panel/ministories.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/typeahead.bundle.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/handlebars-v1.3.0.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/panel/appointment-creation.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/panel/story-creation.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/sprite/story-viewer.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/nunjucks.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/panel/chat.js' %}"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>
        <!--
        <script type="text/javascript" src="{% static 'js/panel/admissions.js' %}"></script>
        -->
        <script type="text/javascript">
            $(document).ready(function(){
                $("#heading").stick_in_parent();
                $("#patient-bio").stick_in_parent();
                $('#story_creation_button').click(function(){
                    var panel = $('#story_creation_panel');
                    if(panel.is(':visible')){
                        panel.hide();
                        $('#story_creation_button').show();
                    }else{
                        panel.show();
                        $('#story_creation_button').hide();
                    }
                });
                $('#story_creation_reset').click(function(){
                    $('#story_creation_button').trigger('click');
                });
                $('#story_creation_form').submit(function(e){
                    e.preventDefault();
                    var overlay = $('#story_creation_panel .story-creation-form-overlay');
                    $('.form-field-error ul').html('');
                    overlay.addClass('story-creation-form-overlay-loading');
                    var form_data = $(this).serializeArray();
                    form_data.push({'name': 'is_prescription', 'value': 'on'});
                    $.ajax({
                        url:  $(this).attr('action'),
                        data: form_data,
                        type: 'POST',
                        success: function(data){
                            overlay.removeClass('story-creation-form-overlay-loading');
                            overlay.html('');
                            if(data.success){
                                overlay.addClass('story-creation-form-overlay-success');
                                overlay.html('Successfully Created Story');
                                overlay.show();
                                setTimeout(function(){
                                    overlay.removeClass('story-creation-form-overlay-success');
                                    overlay.html('');
                                    overlay.hide();
                                    $('#story_creation_button').trigger('click');
                                }, 1500);
                            }else{
                                $.each(data.errors, function(key, errors){
                                    var elem = $('#id_'+key);
                                    var error_div = $(elem.siblings('.form-field-error')[0]);
                                    var error_ul = error_div.find('ul');
                                    error_ul.html('');
                                    $.each(errors, function(i, error){
                                        var li = $("<li>"+error+"</li>");
                                        error_ul.append(li);
                                    });
                                });
                            }
                            console.log(data);
                        },
                        error: function(xhr){
                            overlay.removeClass('story-creation-form-overlay-loading');
                            overlay.html('');
                            if(xhr.status == 403){
                                var error_panel =  $('#story_creation_panel .form-error');
                                error_panel.html('You are Not Authorized to Create an Appointment');
                            }
                        }
                    });
                    return false;
                });
                Array.prototype.removeValue = function(name, value){
                   var array = $.map(this, function(v,i){
                      return v[name] === value ? null : v;
                   });
                   this.length = 0; //clear original array
                   this.push.apply(this, array); //push all elements except the one we want to delete
                }
                var render_prescription = function(){
                  var prescription = $("#prescription");
                  var json = prescription.data("prescription");
                  var body = $("#prescription_body");
                  body.html('');
                  $(json.medicines).each(function(){
                    if(this.type == 'periodic'){
                        var interval_text = '';
                        if(this.interval <= 24 && 24 % this.interval == 0){
                            interval_text = 24/this.interval + " times daily";
                        }else if(this.interval % 24 == 0){
                            var di = this.interval/24;
                            var dit = '';
                            if(di%10 == 1) dit = "st";
                            else if(di%10 == 2) dit = "nd";
                            else if(di%10 == 3) dit = "rd";
                            else dit = "th";
                            interval_text = "Every "+di+dit+" day";
                        }else{
                            interval_text = "Every "+this.interval + " hours";
                        }
                        var termination_text = (this.termination == -1) ? "untill prescribed to stop" : "For "+ this.termination+ " days";
                        var when_text = this.when;
                        var note_text = this.note.length ? ("("+this.note+")") : "";

                        body.append($('<div data-id="'+this.id+'" data-key="medicines" class="prescription-entry medication-periodic well well-sm"> \
                                        <div class="prescription-entry-remove glyphicon glyphicon-remove"></div>                                    \
                                        <div class="medicine-name">'+this.name+'</div>                                                              \
                                        <div class="medicine-dose">'+this.dose+'mg</div>                                                            \
                                        <div class="medicine-interval">'+interval_text+'</div>                                                      \
                                        <div class="medicine-termination">'+termination_text+'</div>                                                \
                                        <div class="medicine-when">'+when_text+'</div>                                                              \
                                        <div class="medicine-note">'+note_text+'</div>                                                              \
                                        </div>'));
                    }else if(this.type == 'asrequired'){
                        body.append($('<div data-id="'+this.id+'" data-key="medicines" class="prescription-entry medication-periodic well well-sm"> \
                                        <div class="prescription-entry-remove glyphicon glyphicon-remove"></div>                                    \
                                        <div class="medicine-name">'+this.name+'</div>                                                              \
                                        <div class="medicine-dose">'+this.dose+'mg</div>                                                            \
                                        <div class="medicine-situation">'+this.situation+'</div>                                                    \                                   \
                                        </div>'));
                    }else if(this.type == 'investigation'){
                        body.append($('<div data-id="'+this.id+'" data-key="medicines" class="prescription-entry medication-periodic well well-sm"> \
                                        <div class="prescription-entry-remove glyphicon glyphicon-remove"></div>                                    \
                                        <div class="medicine-name">'+this.name+'</div>                                                              \
                                        <div class="medicine-note">'+this.note+'</div>                                                            \                                   \
                                        </div>'));
                    }else if(this.type == 'advice'){
                        body.append($('<div data-id="'+this.id+'" data-key="medicines" class="prescription-entry medication-periodic well well-sm"> \
                                        <div class="prescription-entry-remove glyphicon glyphicon-remove"></div>                                                         \
                                        <div class="medicine-note">'+this.note+'</div>                                                            \                                   \
                                        </div>'));
                    }
                  });
                  $("#id_body").val(JSON.stringify(json));
                }
                $("#prescription_body").on('click', 'div.prescription-entry div.prescription-entry-remove', function(){
                  var parent = $(this).parent();
                  var id = parent.data('id');
                  var key = parent.data('key');
                  var prescription = $("#prescription");
                  var json = prescription.data("prescription");
                  json[key].removeValue('id', id);
                  prescription.data("prescription", json);
                  $("#id_body").val(JSON.stringify(json));
                  render_prescription();
                  console.log(json);
                });
                $("#periodic_medication").click(function(){
                    $('#prescription_body_editor').html('');
                    $('#prescription_body_editor').append($($('#snippet_medication_periodic').html()));
                    $('#prescription_body_editor').css('display', 'block');
                });
                $("#test_medication").click(function(){
                    $('#prescription_body_editor').html('');
                    $('#prescription_body_editor').append($($('#snippet_investigation').html()));
                    $('#prescription_body_editor').css('display', 'block');

                    var investigation_data = {
                        category: 'investigation',
                        subcategories: [{
                                category: 'Pathology',
                                subcategories: [{
                                    category: 'Blood',
                                    subcategories: [{
                                        category: 'CBC'
                                    },{
                                        category: 'Suger'
                                    },{
                                        category: 'LFT'
                                    },{
                                        category: 'Lipid Profile'
                                    },{
                                        category: 'TSH'
                                    }]
                                },{
                                    category: 'Urine',
                                    subcategories: [{
                                        category: 'RE'
                                    },{
                                        category: 'ME'
                                    },{
                                        category: 'C/S'
                                    }]
                                },{
                                    category: 'Stool',
                                    subcategories: [{
                                        category: 'RE'
                                    },{
                                        category: 'ME'
                                    },{
                                        category: 'OBT'
                                    }]
                                }]
                            },{
                                category: 'Radiology',
                                subcategories: [{
                                    category: 'X-Ray'
                                },{
                                    category: 'USG'
                                },{
                                    category: 'CT'
                                },{
                                    category: 'MR'
                                },{
                                    category: 'Other'
                                }]
                            },{
                                category: 'Cardiology',
                                subcategories: [{
                                    category: 'ECG'
                                }]
                            },{
                                category: 'Nemology'
                            },{
                                category: 'Gastro'
                            }
                    ]};
                    var decorate = function(node){
                        node.elem = $('<a class="list-group-item list-group-item investigation-item" data-id="{0}">{1}</a>'.format(node.id, node.category));
                        return node.elem;
                    }
                    var decorate_list = function(nodes){
                        var elem = $('<div class="list-group investigation-list">');
                        for(i in nodes){
                            if(nodes.hasOwnProperty(i)){
                                elem.append(decorate(nodes[i]));
                            }
                        }
                        return elem;
                    }
                    var collapse = function(node){
                        var children = node.children;
                        children.css('display', 'none');
                        if(node.subcategories.length > 0){
                            for(i in node.subcategories){
                                if(node.subcategories.hasOwnProperty(i)){
                                    collapse(node.subcategories[i]);
                                }
                            }
                        }
                    }
                    var c = 0;
                    var travarse = function(node, visitor){
                        node.id = c++;
                        if(node.subcategories === undefined){
                            node.subcategories = [];
                        }
                        var decoration = decorate_list(node.subcategories);
                        node.children = decoration;
                        if(node.elem){
                            $(node.elem).click(function(){
                                for(i in node.siblings){
                                    if(node.siblings.hasOwnProperty(i)){
                                        collapse(node.siblings[i]);
                                    }
                                }
                                visitor(node);
                            });
                        }
                        if(node.subcategories.length > 0){
                            for(i in node.subcategories){
                                if(node.subcategories.hasOwnProperty(i)){
                                    node.subcategories[i].siblings = node.subcategories;
                                    travarse(node.subcategories[i], visitor);
                                }
                            }
                        }
                        return decoration;
                    }
                    var decoration = travarse(investigation_data, function(node){
                        node.children.css('display', 'block');
                        $('#prescription_body_editor').find('.investigation-container').append(node.children);
                    });
                    $('#prescription_body_editor').find('.investigation-container').append(decoration);
                });
                // $("#asrequired_medication").click(function(){
                //   var form = $('<form> \
                //       <div class="input-group"> \
                //         <span class="input-group-addon" id="basic-addon1">Medicine Name</span> \
                //         <input name="medname" type="text" class="form-control" placeholder="Medicine Name" aria-describedby="basic-addon1"> \
                //         <span class="input-group-addon" id="basic-addon1">Dose</span> \
                //         <input name="meddose" type="text" class="form-control" placeholder="in mg" aria-describedby="basic-addon1"> \
                //       </div> \
                //       <div class="input-group"> \
                //         <span class="input-group-addon" id="basic-addon1">Situation</span> \
                //         <input name="medcase" type="text" class="form-control" placeholder="situation" aria-describedby="basic-addon1"> \
                //       </div> \
                //     </form>');
                //   bootbox.confirm(form, function(result){
                //       if(!result) return false;
                //       var name = form.find('input[name=medname]').val();
                //       var dose = form.find('input[name=meddose]').val();
                //       var situation = form.find('input[name=medcase]').val();
                //       var data = {"id": (+new Date)+Math.random(), "type": "asrequired", "name": name, "dose": dose, "situation": situation};
                //       var prescription = $("#prescription");
                //       var pdata = prescription.data("prescription");
                //       pdata["medicines"].push(data);
                //       prescription.data("prescription", pdata);
                //       render_prescription();
                //   });
                // });
                $("#advice_medication").click(function(){
                    bootbox.prompt({
                        title: "Advice to Patient",
                        inputType: 'textarea',
                        callback: function (result){
                            var data = {"id": (+new Date)+Math.random(), "type": "advice", "note": result};
                            var prescription = $("#prescription");
                            var pdata = prescription.data("prescription");
                            pdata["medicines"].push(data);
                            prescription.data("prescription", pdata);
                            render_prescription();
                        }
                    });
                });
                // $("#test_medication").click(function(){
                //   var form = $('<form> \
                //       <div class="input-group"> \
                //         <select name="medtest" class="selectpicker"> \
                //           <option value="xray">X-Ray</option> \
                //           <option value="test1">Test #1</option> \
                //           <option value="test2">Test#2</option> \
                //         </select> \
                //         <input name="mednote" type="text" class="form-control" placeholder="note" aria-describedby="basic-addon1"> \
                //       </div> \
                //     </form>');
                //   bootbox.confirm(form, function(result){
                //       if(!result) return false;
                //       var name = form.find(".selectpicker").find("option:selected").val();
                //       var note = form.find('input[name=mednote]').val();
                //       var data = {"id": (+new Date)+Math.random(), "type": "investigation", "name": name, "note": note};
                //       var prescription = $("#prescription");
                //       var pdata = prescription.data("prescription");
                //       pdata["medicines"].push(data);
                //       prescription.data("prescription", pdata);
                //       render_prescription();
                //   });
                //   $('.selectpicker').selectpicker({
                //     size: 4
                //   });
                // });
                $("#remark_medication").click(function(){
                  alert(3);
                });

                $("#prescription_body_editor").on('click', "ul.med-freq-selector li", function(){
                    var freq = parseInt($(this).attr('data-freq'));
                    var freq_row = $(this).closest('.frequency-row');
                    $(freq_row).find(".medication-mode").attr('data-freq', freq);
                    $(freq_row).find(".medication-mode").attr('data-mode', '');
                    $(freq_row).find('.medicine-editor-med-frequency').attr('data-freq', freq);
                    $(freq_row).find('.medicine-editor-med-frequency').html('Frequency ('+freq+') <span class="caret"></span>');

                    $(freq_row).find('.med-timmed-clocks').html('');
                    $(freq_row).find('.med-timmed-clocks').css('display', 'none');
                    $(freq_row).find('.med-event').css('display', 'none');
                    $(freq_row).find('.med-asneeded')[0].style.setProperty('display', 'none', 'important');
                    $(freq_row).find(".medication-mode").css('display', 'none');
                    console.log(freq);
                    if(freq > 0){
                        $(freq_row).find(".medication-mode").css('display', 'block');
                        $(freq_row).parent().find(".med-termination").removeAttr('disabled');
                        $(freq_row).find('.med-days').find('.dropdown-toggle').removeClass('disabled');
                    }else if(freq == 0){
                        $(freq_row).find('.med-asneeded')[0].style.setProperty('display', 'inline-table', 'important');
                        $(freq_row).parent().find(".med-termination").attr('disabled', 'disabled');
                        $(freq_row).find('.med-days').find('.dropdown-toggle').addClass('disabled');
                    }
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $("#prescription_body_editor").on('click', ".med-dose-unit ul.dropdown-menu li", function(){
                    var unit = $(this).closest('.med-dose-unit');
                    unit.attr('data-unit', $(this).attr('value'));
                    unit.find('.dropdown-toggle').html("Unit ("+unit.attr('data-unit')+') <span class="caret"></span>');

                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $("#prescription_body_editor").on('click', ".med-days ul.dropdown-menu li", function(){
                    var unit = $(this).closest('.med-days');
                    unit.attr('data-days', $(this).attr('value'));
                    unit.attr('data-interval', $(this).attr('data-interval'));
                    unit.find('.dropdown-toggle').html("Days ("+unit.attr('data-days')+') <span class="caret"></span>');

                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $("#prescription_body_editor").on('change', '.medicine-editor-med-type .btn input', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $("#prescription_body_editor").on('change', '.med-when-ba .btn input', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $("#prescription_body_editor").on('change', '.med-when-context .btn input', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('click', '.med-mode-timmed', function(){
                    var template = $($('.med-timmed-clock-template')[0]).html();
                    var form = $(this).parent().parent().parent();
                    var freq = parseInt($(this).parent().parent().attr('data-freq'));
                    $(form).find('.med-timmed-clocks').html('');
                    for(var i =0; i< freq; ++i){
                        $(form).find('.med-timmed-clocks').append($(template));
                    }
                    $(form).find('.med-timmed-clocks').css('display', 'block');
                    $(this).parent().parent().css('display', 'none');
                    $(this).parent().parent().attr('data-mode', 'clock');
                    $('.clockpicker').clockpicker();

                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('click', '.med-mode-event', function(){
                    var med_event = $(this).closest('.form-inline').find('.med-event')[0];
                    med_event.style.setProperty('display', 'inline-table', 'important');
                    $(this).parent().parent().css('display', 'none');
                    $(this).parent().parent().attr('data-mode', 'event');

                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('click', '.medicine-editor-med-okay', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('keyup', '.med-name', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('keyup', '.med-termination', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('keyup', '.med-dose', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('keyup', '.med-usecase', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('propertychange change keyup paste input', 'div.med-timmed-clocks .med-clock', function(){
                    var editor = $(this).closest('.editor-panel');
                    make_medicine(editor);
                });
                $('#prescription_body_editor').on('click', '.translate-bn', function(){
                    var container = $(this).closest('.translatable-compound').find('.translatable-tokens');
                    $(container).find('.translatable > .tag-active').removeClass('tag-active');
                    $(container).find('.translatable > .tag-bn').addClass('tag-active');
                    var tokens = $(container).find('.translatable');
                    tokens.each(function(i,v){
                        $(this).attr('data-index', i);
                    });
                    tokens.sort(function(a,b){
                        var order_a = parseFloat($(a).find('.tag-active').attr('data-order'));
                        var order_b = parseFloat($(b).find('.tag-active').attr('data-order'));
                        var delta = order_a - order_b;
                        if(delta == 0){
                            return parseInt($(a).attr('data-index')) - parseInt($(b).attr('data-index'));
                        }
                        return delta;
                    });
                    container.html('');
                    container.append(tokens);
                });
                $('#prescription_body_editor').on('click', '.translate-en', function(){
                    var container = $(this).closest('.translatable-compound').find('.translatable-tokens');
                    $(container).find('.translatable > .tag-active').removeClass('tag-active');
                    $(container).find('.translatable > .tag-en').addClass('tag-active');
                    var tokens = $(container).find('.translatable');
                    tokens.each(function(i,v){
                        $(this).attr('data-index', i);
                    });
                    tokens.sort(function(a,b){
                        var order_a = Math.round(parseFloat($(a).find('.tag-active').attr('data-order'))*10);
                        var order_b = Math.round(parseFloat($(b).find('.tag-active').attr('data-order'))*10);
                        var delta = order_a - order_b;
                        if(delta == 0){
                            return parseInt($(a).attr('data-index')) - parseInt($(b).attr('data-index'));
                        }
                        return delta;
                    });
                    container.html('');
                    container.append(tokens);
                });
                $('#prescription_body_editor').on('click', '.medicine-editor-med-cancel', function(){
                    $('#prescription_body_editor').html('');
                    $('#prescription_body_editor').css('display', 'none');
                });
            });
        </script>
        <script type="text/javascript">
            var dict = {
                'tablet':       {'bn': 'ট্যাবলেট'},
                'capsule':      {'bn': 'ক্যাপসুল '},
                'ointment':     {'bn': 'মলম'},
                'injection':    {'bn': 'ইনজেকশন '},
                'syrup':        {'bn': 'সিরাপ'},

                'once':         {'bn': 'এক বার'},
                'twice':        {'bn': 'দু বার'},
                'thrice':       {'bn': 'তিন বার'},
                'times':        {'bn': 'বার'},
                'daily':        {'bn': 'দিনে'},
                'everyday':     {'bn': 'প্রতিদিন'},
                'every':        {'bn': 'প্রতি'},
                'day':          {'bn': 'দিন'},
                'days':         {'bn': 'দিন'},

                'before':       {'bn': 'এর আগে'},
                'after':        {'bn': 'এর পরে'},
                'breakfast':    {'bn': 'প্রাতরাশ'},
                'lunch':        {'bn': 'মধ্যাহ্নভোজ'},
                'dinner':       {'bn': 'সান্ধ্যভোজন'},

                'and':          {'bn': 'এবং'}
            };
            function tr(phrase, lang){
                if(phrase in dict){
                    return dict[phrase].bn;
                }
                return phrase;
            }
            String.prototype.format = function() {
                var formatted = this;
                for( var arg in arguments ) {
                    formatted = formatted.replace("{" + arg + "}", arguments[arg]);
                }
                return formatted;
            };
            function create_prescription(div, story_id, patient_id, patient_name){
                var story_viewer = $(div).closest('.story-viewer');
                console.log(story_viewer);
                story_viewer.css('left', '0px');
                $('.story-viewer').each(function(){
                    if(this != story_viewer[0]) $(this).remove();
                })
                console.log(story_id, patient_id, patient_name);
                var panel = $('#story_creation_panel');
                panel.show();
                $("#id_patient").val(patient_id);
                $("#id_patient_selector").val(patient_name);
                $('#id_story_referer').val(story_id);
                $('.story-refer').trigger("click");
            }
            function make_med_text(medicine){
                var error_text = "";
                function sanity(value, key){
                    if(value === undefined || (typeof value == 'string' && !value.length) || (typeof value == 'number' && isNaN(value))){
                        if(error_text.length == 0)
                            error_text = "<span class='error-input'>Invalid/No {0}</span>".format(key);
                        return '';
                    }
                    return value;
                }
                var str = " <span class='translatable'><span class='tag tag-en tag-active' data-order='1'>{0}</span><span class='tag tag-bn' data-order='1'>{1}</span></span> \
                            <span class='translatable'><span class='tag tag-en tag-active' data-order='2'>{2}</span><span class='tag tag-bn' data-order='2'>{3}</span></span></span> \
                            <span class='translatable'><span class='tag tag-en tag-active' data-order='3'>{4}</span><span class='tag tag-bn' data-order='3'>{5}</span></span></span> \
                            <span class='translatable'><span class='tag tag-en tag-active' data-order='4'>{6}</span><span class='tag tag-bn' data-order='4'>{7}</span></span></span>"
                            .format(
                                sanity(medicine.type, "type"), tr(sanity(medicine.type, "type")),
                                sanity(medicine.name, "name"), tr(sanity(medicine.name, "name")),
                                sanity(medicine.dose, "dose"), tr(sanity(medicine.dose, "dose")),
                                sanity(medicine.unit, "unit"), tr(sanity(medicine.unit, "unit"))
                            );
                if(sanity(medicine.interval.frequency, "frequency") > 0){
                    var freq_text = "";
                    switch(sanity(medicine.interval.frequency, "frequency")){
                        case 1: 
                            freq_text = "<span class='translatable'><span class='tag tag-en tag-active' data-order='5'>{0}</span><span class='tag tag-bn' data-order='6'>{1}</span></span>".format("once", tr("once"));
                            break;
                        case 2: 
                            freq_text = "<span class='translatable'><span class='tag tag-en tag-active' data-order='5'>{0}</span><span class='tag tag-bn' data-order='6'>{1}</span></span>".format("twice", tr("twice"));
                            break;
                        case 3: 
                            freq_text = "<span class='translatable'><span class='tag tag-en tag-active' data-order='5'>{0}</span><span class='tag tag-bn' data-order='6'>{1}</span></span>".format("thrice", tr("thrice"));
                            break;
                        default: 
                            freq_text = "<span class='translatable'><span class='tag tag-en tag-active' data-order='5'  >{0}</span><span class='tag tag-bn' data-order='6'  >{1}</span></span> \
                                        <span class='translatable'><span class='tag tag-en tag-active' data-order='5.1'>{2}</span><span class='tag tag-bn' data-order='6.1'>{3}</span></span>"
                            .format(
                                sanity(medicine.interval.frequency, 'frequency'), tr(sanity(medicine.interval.frequency, 'frequency')), 
                                "times", tr("times")
                            );
                    }
                    str += freq_text+"<span class='translatable'><span class='tag tag-en tag-active' data-order='6'>{0}</span><span class='tag tag-bn' data-order='5'>{1}</span></span>".format("daily", tr("daily"));
                    if(typeof sanity(medicine.interval.days, "days interval") == 'number'){
                        var days_interval_text = "";
                        switch(medicine.interval.days){
                            case 0:
                                days_interval_text = "<span class='translatable'><span class='tag tag-en tag-active' data-order='7'>{0}</span><span class='tag tag-bn' data-order='7'>{1}</span></span>".format("everyday", tr("everyday"));
                                break;
                            case 1:
                                days_interval_text = "<span class='translatable'><span class='tag tag-en tag-active' data-order='7'>{0}</span><span class='tag tag-bn' data-order='7'>{1}</span></span>".format("every alternate day", "এক দিন অন্তর");
                                break;
                            case 2:
                                days_interval_text = "<span class='translatable'><span class='tag tag-en tag-active' data-order='7'>{0}</span><span class='tag tag-bn' data-order='7'>{1}</span></span>".format("every third day", "২ দিন অন্তর");
                                break;
                            default:
                                days_interval_text = "<span class='translatable'><span class='tag tag-en tag-active' data-order='7'>{0}</span><span class='tag tag-bn' data-order='7'>{1}</span></span>".format("every {0}th day".format(medicine.interval.days), "{0} দিন অন্তর".format(tr(medicine.interval.days-1)));
                        }
                        str += days_interval_text;
                    }

                    if(medicine.interval.mode == 'clock'){
                        if(Array.from(new Set(medicine.interval.clocks)).length != medicine.interval.clocks.length){
                            if(error_text.length == 0)
                                error_text = "<span class='error-input'>Duplicate time in schedule</span>";
                        }
                        if(medicine.interval.clocks.length > 0){
                            str += "<span class='translatable'><span class='tag tag-en tag-active' data-order='8'>{0}</span><span class='tag tag-bn' data-order='8.1'>{1}</span></span>".format("on", "এ");
                        }
                        $(medicine.interval.clocks).each(function(i, v){
                            str += "<span class='translatable'><span class='tag tag-en tag-active' data-order='8.1'>{0}</span><span class='tag tag-bn' data-order='8'>{1}</span></span>".format(this, tr(this));
                            str += (i == medicine.interval.clocks.length-2) ? "<span class='translatable'><span class='tag tag-en tag-active' data-order='8.1'>{0}</span><span class='tag tag-bn' data-order='8'>{1}</span></span>".format("and", tr("and")) : ((i < medicine.interval.clocks.length-1) ? "<span class='translatable'><span class='tag tag-en tag-active' data-order='8.1'>,</span><span class='tag tag-bn' data-order='8'>,</span></span>" : "");
                        });
                    }else if(medicine.interval.mode == 'event'){
                        if(medicine.interval.event.context.length != medicine.interval.frequency){
                            if(error_text.length == 0)
                                error_text = "<span class='error-input'>Expecting {0} doses, marked {1} doses {2}</span>".format(medicine.interval.event.context, medicine.interval.frequency, medicine.interval.event.context.join(' '));
                        }
                        str += "<span class='translatable'><span class='tag tag-en tag-active' data-order='8'>{0}</span><span class='tag tag-bn' data-order='8.1'>{1}</span></span>".format(sanity(medicine.interval.event.when, "when"), tr(sanity(medicine.interval.event.when, "when")));
                        $(medicine.interval.event.context).each(function(){
                            str += "<span class='translatable'><span class='tag tag-en tag-active' data-order='8'>{0}</span><span class='tag tag-bn' data-order='8.1'>{1}</span></span>".format(this, tr(this));
                        });
                    }else{
                        if(error_text.length == 0)
                            error_text = "<span class='error-input'>Invalid/No mode (clock | event)</span>";
                    }

                    if(sanity(medicine.termination, "termination") <= 0){
                        if(error_text.length == 0)
                            error_text = "<span class='error-input'>Termination must be more than 0 days</span>";
                    }else{
                        str += "<span class='translatable'><span class='tag tag-en tag-active' data-order='9' >{0}</span><span class='tag tag-bn' data-order='11'>{1}</span></span> \
                                <span class='translatable'><span class='tag tag-en tag-active' data-order='10'>{2}</span><span class='tag tag-bn' data-order='9' >{3}</span></span> \
                                <span class='translatable'><span class='tag tag-en tag-active' data-order='11'>{4}</span><span class='tag tag-bn' data-order='10'>{5}</span></span>"
                                .format(
                                    "for", "পর্যন্ত", 
                                    medicine.termination, tr(medicine.termination),
                                    "days", tr("days")
                                );
                    }
                }else{
                    str += "<span class='translatable'><span class='tag tag-en tag-active' data-order='4'>({0})</span><span class='tag tag-bn' data-order='4'>({1})</span></span></span>"
                            .format(medicine.interval.custom, medicine.interval.custom);
                }
                var valid = (error_text.length == 0);
                
                return {
                    'valid': valid, 
                    'text': "<div class='translatable-compound'> \
                                <div class='translatable-tokens'>{0}</div> \
                                <div class='translation-actions'><div class='translation-action translate-bn'>bn</div><div class='translation-action translate-en'>en</div></div> \
                            </div>".format(error_text+str)
                    };
            }
            function make_medicine(elem){
                var medicine = {
                    type: '', // tablet | capsule | ointment | injection 
                    name: '', // name of the medicine
                    dose: 0,  // dose
                    unit: '', // unit of dose
                    termination: 0, // for how many days
                    interval: {
                        frequency: '', // numeric | 0 means as needed | -1 means custom
                        days: 0, // days interval
                        mode: '',    // clock or event
                        clocks: [],
                        event: {
                            context: [], // breakfast | Lunch | Dinner | Anytime
                            when: '' // before | after | not applicable 
                        },
                        custom: ''
                    },
                    note: '' // some extra notes if required
                };

                medicine.type               = $(elem).find('.medicine-editor-med-type').find('input:radio:checked').val();
                medicine.name               = $(elem).find('.med-name').val();
                medicine.dose               = parseInt($(elem).find('.med-dose').val());
                medicine.unit               = $(elem).find('.med-dose-unit').attr('data-unit');
                medicine.termination        = parseInt($(elem).find('.med-termination').val());
                medicine.interval.frequency = parseInt($(elem).find('.medicine-editor-med-frequency').attr('data-freq'));
                medicine.interval.days      = parseInt($(elem).find('.med-days').attr('data-interval'));
                medicine.interval.mode      = $(elem).find('.medication-mode').attr('data-mode');
                medicine.interval.custom    = $(elem).find('.med-usecase').val();

                medicine.interval.clocks    = [];
                var clocksv = $(elem).find('.med-timmed-clocks')[0];
                var clocks = $(clocksv).find('.med-clock');
                $(clocks).each(function(){
                    var input = $(this).find('input');
                    var time = $(input).val();
                    medicine.interval.clocks.push(time);
                });

                var contexts = $(elem).find('.med-when-context').find('input:checkbox:checked');
                var ctxs = [];
                $(contexts).each(function(){
                    ctxs.push($(this).val());
                });
                medicine.interval.event.when = $(elem).find('.med-when-ba').find('input:radio:checked').val();
                medicine.interval.event.context = ctxs;

                var summary = make_med_text(medicine);
                $(elem).find('.medicine-editor-med-okay').prop("disabled", !summary.valid);
                $(elem).find('.medicine-text').html(summary.text);

                console.log(medicine);
            }
        </script>
    </head>
    <body>
        <div class="heading" id="heading">
            <div class="logo">//smcc:identity//</div>
            <div class="user">
                <a id="user_button" href="{% url 'doctor' doctor.id %}">{{request.user.get_short_name}}</a>
                <div class="user-menu" id="user_menu">
                    <ul class="user-menu-options">
                        <li class="user-menu-option"><a href="/user/land">Profile</a></li>
                        <li class="user-menu-option">Account</li>
                        <li class="user-menu-option user-menu-option-break">&nbsp;</li>
                        <li class="user-menu-option user-menu-option-last"><a href="/user/logout">Logout</a></li>
                    </ul>
                </div>
            </div>
            <div class="search">
                <input type="text" value="" class="search-input" />
            </div>
            <div class="map"></div>
        </div>
        <div class="main" id="main">
            {% view 'identity.panels.DoctorPanel' doctor %}
            <div class="content">
                {% for notice in notices %}
                    {% view 'identity.sprites.NoticeSprite' notice %}
                {% endfor %}
                {% view 'identity.panels.AdmissionsPanel' admissions %}
                {% view 'identity.panels.AppointmentsPanel' appointments %}
                {% view 'identity.panels.MiniStoriesPanel' stories nstories doctor %}
                {% view 'identity.panels.PatientsPanel' patients %}
            </div>
            {% view 'identity.panels.RandomStoryCreationPanel' story_form %}
            {% view 'identity.panels.ChatPanel' %}
        </div>
        <div id="snippet_store">
            <div id="snippet_medication_periodic" class="snippet">
                <div class="panel panel-default editor-panel">
                    <div class="panel-body">
                        <div class="well well-sm">
                            <div class="btn-group medicine-editor-med-type" data-toggle="buttons">
                                <label class="btn btn-primary">
                                    <input type="radio" name="options_type" id="option_type1" autocomplete="off" value="tablet"> Tablet
                                </label>
                                <label class="btn btn-primary">
                                    <input type="radio" name="options_type" id="option_type2" autocomplete="off" value="capsule"> Capsule
                                </label>
                                <label class="btn btn-primary">
                                    <input type="radio" name="options_type" id="option_type3" autocomplete="off" value="syrup"> Syrup
                                </label>
                                <label class="btn btn-primary">
                                    <input type="radio" name="options_type" id="option_type3" autocomplete="off" value="ointment"> Ointment
                                </label>
                                <label class="btn btn-primary">
                                    <input type="radio" name="options_type" id="option_type3" autocomplete="off" value="injection"> Injection
                                </label>
                            </div>
                            <div class="medicine-editor-med-control">
                                <button type="button" class="btn btn-success medicine-editor-med-okay" aria-label="Left Align">
                                    <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn btn-danger medicine-editor-med-cancel" aria-label="Left Align">
                                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>

                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">Name</span>
                            <input name="medname" type="text" class="form-control med-name" placeholder="Medicine Name" aria-describedby="basic-addon1">
                            <span class="input-group-addon" id="basic-addon1">Dose</span>
                            <input name="meddose" type="text" class="form-control med-dose" placeholder="in mg" aria-describedby="basic-addon1">
                            <div class="input-group-btn med-dose-unit">
                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Unit <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li value="mg"><a href="#">mg</a></li>
                                    <li value="Mg"><a href="#">Mg</a></li>
                                    <li value="g"><a href="#">g</a></li>
                                    <li role="separator" class="divider"></li>
                                    <li value="ml"><a href="#">ml</a></li>
                                </ul>
                            </div>
                            <span class="input-group-addon" id="basic-addon1">For</span>
                            <input name="medtermination" type="text" class="form-control med-termination" placeholder="in days" aria-describedby="basic-addon1">
                            <span class="input-group-addon" id="basic-addon1">Days</span>
                        </div>
                        <div class="input-group frequency-row">
                            <div class="input-group-btn med-days">
                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Days Interval <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li data-interval="0" value="Everyday"><a href="#">Daily</a></li>
                                    <li data-interval="1" value="Every other day"><a href="#">Alternate Day</a></li>
                                    <li data-interval="2" value="3rd"><a href="#">Every 3rd Day</a></li>
                                    <li data-interval="3" value="4th"><a href="#">Every 4th Day</a></li>
                                    <li data-interval="4" value="5th"><a href="#">Every 5th Day</a></li>
                                    <li data-interval="5" value="6th"><a href="#">Every 6th Day</a></li>
                                    <li data-interval="6" value="7th"><a href="#">Every 7th Day</a></li>
                                    <li data-interval="7" value="8th"><a href="#">Every 8th Day</a></li>
                                    <li data-interval="8" value="9th"><a href="#">Every 9th Day</a></li>
                                    <li data-interval="9" value="10th"><a href="#">Every 10th Day</a></li>
                                    <li data-interval="10" value="11th"><a href="#">Every 11th Day</a></li>
                                </ul>
                            </div>
                            <div class="input-group-btn dropup">
                                <button type="button" class="btn btn-default dropdown-toggle medicine-editor-med-frequency" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Frequency <span class="caret"></span>
                                </button>
                                <ul class="med-freq-selector dropdown-menu">
                                    <li data-freq="1"><a href="#">Once (1)</a></li>
                                    <li data-freq="2"><a href="#">Twice (2)</a></li>
                                    <li data-freq="3"><a href="#">Thrice (3)</a></li>
                                    <li data-freq="4"><a href="#">4 Times</a></li>
                                    <li data-freq="5"><a href="#">5 Times</a></li>
                                    <li data-freq="6"><a href="#">6 Times</a></li>
                                    <li role="separator" class="divider"></li>
                                    <li data-freq="0"><a href="#">As Needed</a></li>
                                    <li role="separator" class="divider"></li>
                                    <li data-freq="-1"><a href="#">Others</a></li>
                                </ul>
                            </div>
                            <div class="form-inline">
                                <div class="btn-group btn-group-justified medication-mode" role="group" aria-label="..." data-freq="" data-mode="">
                                    <div class="btn-group" role="group">
                                        <button id="" type="button" class="btn btn-success med-mode-timmed">Clock</button>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button id="" type="button" class="btn btn-success med-mode-event">Event</button>
                                    </div>
                                </div>
                                <div class="input-group form-inline col-md-12 med-asneeded">
                                    <span class="input-group-addon" id="basic-addon1" style="width: 80px;">Use Case</span>
                                    <input name="med-usecase" type="text" class="form-control med-usecase" placeholder="Case" aria-describedby="basic-addon1">
                                </div>
                                <div class="med-timmed-clock-template">
                                    <div class="input-group clockpicker med-clock" data-placement="left" data-align="top" data-autoclose="true">
                                        <input type="text" class="form-control" value="00:00">
                                        <span class="input-group-addon">
                                            <span class="glyphicon glyphicon-time"></span>
                                        </span>
                                    </div>
                                </div>
                                <div id="" class="med-timmed-clocks"></div>
                                <div id="" class="med-event input-group form-inline">
                                    <div class="btn-group med-when-ba" data-toggle="buttons">
                                        <label class="btn btn-info active">
                                            <input type="radio" name="options_ab" id="option_ab2" autocomplete="off" value="n/a"> Not Applicable
                                        </label>
                                        <label class="btn btn-info">
                                            <input type="radio" name="options_ab" id="option_ab1" autocomplete="off" value="before"> Before
                                        </label>
                                        <label class="btn btn-info">
                                            <input type="radio" name="options_ab" id="option_ab3" autocomplete="off" value="after"> After
                                        </label>
                                    </div>
                                    <div class="btn-group med-when-context" data-toggle="buttons">
                                        <label class="btn btn-info">
                                            <input type="checkbox" name="options_ctx" id="option_ctx2" autocomplete="off" value="anytime"> Anytime
                                        </label>
                                        <label class="btn btn-info">
                                            <input type="checkbox" name="options_ctx" id="option_ctx1" autocomplete="off" value="breakfast"> Breakfast
                                        </label>
                                        <label class="btn btn-info">
                                            <input type="checkbox" name="options_ctx" id="option_ctx3" autocomplete="off" value="lunch"> Lunch
                                        </label>
                                        <label class="btn btn-info">
                                            <input type="checkbox" name="options_ctx" id="option_ctx4" autocomplete="off" value="dinner"> Dinner
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="medicine-text alert alert-success"></div>
                    </div>
                </div>
            </div>
            <div id="snippet_investigation" class="snippet">
                <div class="investigation-container">

                </div>
            </div>
        </div>
    </body>
</html>
